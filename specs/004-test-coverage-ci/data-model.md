# Data Model: Test Coverage & CI Setup

**Feature**: 004-test-coverage-ci  
**Phase**: 1 - Design  
**Date**: 2025-12-24

## Overview

This feature does not introduce new runtime data models (no persistent storage). The entities described here represent the conceptual model of test artifacts, coverage reports, and CI pipeline stages.

---

## Entity: TestResult

**Description**: Represents the outcome of a single test execution (xUnit Fact or Theory)

**Attributes**:
- `TestName` (string): Fully qualified test method name (e.g., `LongMethodRuleTests.Analyze_MethodExceeds20Lines_ReturnsDiagnostic`)
- `Status` (enum): `Passed`, `Failed`, `Skipped`
- `Duration` (TimeSpan): Execution time
- `ErrorMessage` (string?): Failure message if `Status == Failed`
- `StackTrace` (string?): Stack trace if `Status == Failed`

**Validation Rules**:
- `TestName` MUST be unique within a test run
- `Duration` MUST be non-negative
- `ErrorMessage` and `StackTrace` MUST be null when `Status == Passed`

**State Transitions**:
- Not Started → Running → Passed/Failed/Skipped
- No retries: Failed is terminal (Constitutional requirement)

**Examples**:
```json
{
  "TestName": "Lintelligent.AnalyzerEngine.Tests.Rules.LongMethodRuleTests.Analyze_MethodExceeds20Lines_ReturnsDiagnostic",
  "Status": "Passed",
  "Duration": "00:00:00.0123",
  "ErrorMessage": null,
  "StackTrace": null
}
```

---

## Entity: TestCoverageReport

**Description**: Represents code coverage metrics for a test run (generated by Coverlet, parsed by ReportGenerator)

**Attributes**:
- `LineCoveragePercent` (decimal): Percentage of lines executed (0-100)
- `BranchCoveragePercent` (decimal): Percentage of branches executed (0-100)
- `MethodCoveragePercent` (decimal): Percentage of methods executed (0-100)
- `CoveredLines` (int): Total lines executed
- `CoverableLines` (int): Total lines that can be executed
- `FileReports` (List<FileCoverageReport>): Per-file breakdown

**Validation Rules**:
- All percentages MUST be in range [0, 100]
- `CoveredLines` ≤ `CoverableLines`
- `LineCoveragePercent` MUST equal `(CoveredLines / CoverableLines) * 100`

**Success Criteria**:
- `LineCoveragePercent` ≥ 90 (threshold enforcement)

**Examples**:
```json
{
  "LineCoveragePercent": 92.5,
  "BranchCoveragePercent": 88.3,
  "MethodCoveragePercent": 95.0,
  "CoveredLines": 185,
  "CoverableLines": 200,
  "FileReports": [...]
}
```

---

## Entity: FileCoverageReport

**Description**: Coverage metrics for a single source file

**Attributes**:
- `FilePath` (string): Relative path from repository root (e.g., `src/Lintelligent.AnalyzerEngine/Rules/LongMethodRule.cs`)
- `LineCoveragePercent` (decimal): File-specific line coverage
- `CoveredLines` (int): Lines executed in this file
- `CoverableLines` (int): Lines that can be executed in this file
- `UncoveredLineNumbers` (List<int>): Specific line numbers not covered

**Validation Rules**:
- `FilePath` MUST be relative to repository root
- `CoveredLines` ≤ `CoverableLines`

**Use Case**: Identify which files need additional tests

**Examples**:
```json
{
  "FilePath": "src/Lintelligent.AnalyzerEngine/Rules/LongMethodRule.cs",
  "LineCoveragePercent": 100.0,
  "CoveredLines": 25,
  "CoverableLines": 25,
  "UncoveredLineNumbers": []
}
```

---

## Entity: RuleTestSuite

**Description**: Collection of tests for a specific analyzer rule (conceptual grouping)

**Attributes**:
- `RuleId` (string): Rule identifier (e.g., `LNT001`)
- `RuleClassName` (string): Fully qualified class name (e.g., `Lintelligent.AnalyzerEngine.Rules.LongMethodRule`)
- `TestFileName` (string): Test file path (e.g., `tests/Lintelligent.AnalyzerEngine.Tests/Rules/LongMethodRuleTests.cs`)
- `TestMethods` (List<string>): All test method names for this rule
- `CoveragePercent` (decimal): Coverage percentage for the rule class

**Validation Rules**:
- Every rule MUST have at least one test method (FR-001)
- `CoveragePercent` MUST be 100% (FR-002)

**Success Criteria**:
- Test file exists: `RuleClassName` → `{ClassName}Tests.cs`
- All code paths covered: `CoveragePercent == 100.0`

**Examples**:
```yaml
RuleId: LNT001
RuleClassName: Lintelligent.AnalyzerEngine.Rules.LongMethodRule
TestFileName: tests/Lintelligent.AnalyzerEngine.Tests/Rules/LongMethodRuleTests.cs
TestMethods:
  - Analyze_MethodExceeds20Lines_ReturnsDiagnostic
  - Analyze_MethodUnder20Lines_ReturnsNoDiagnostics
  - Analyze_EmptyMethod_ReturnsNoDiagnostics
  - Analyze_NullBody_ReturnsNoDiagnostics
CoveragePercent: 100.0
```

---

## Entity: IntegrationTestScenario

**Description**: Test validating multi-component interaction (AnalyzerEngine + multiple rules + multiple files)

**Attributes**:
- `ScenarioName` (string): Descriptive name (e.g., `AnalyzeMultipleFilesWithMultipleRules`)
- `RegisteredRules` (List<string>): Rule IDs involved (e.g., `["LNT001"]`)
- `InputFiles` (List<string>): Synthetic code samples for testing
- `ExpectedDiagnosticCount` (int): Total diagnostics expected
- `VerifiesErrorHandling` (bool): Whether this scenario tests exception handling

**Validation Rules**:
- At least one registered rule
- At least one input file

**Test Categories**:
1. **Multi-rule orchestration**: Multiple rules analyze same file
2. **Multi-file processing**: Single rule analyzes multiple files
3. **Error resilience**: One rule throws, others continue
4. **Empty scenarios**: Zero rules or zero files

**Examples**:
```yaml
ScenarioName: AnalyzeMultipleFilesWithMultipleRules
RegisteredRules: [LNT001]
InputFiles:
  - "class A { void LongMethod() { /* 25 lines */ } }"
  - "class B { void ShortMethod() { /* 5 lines */ } }"
ExpectedDiagnosticCount: 1  # Only first file triggers LNT001
VerifiesErrorHandling: false
```

---

## Entity: CIPipeline

**Description**: GitHub Actions workflow representing build, test, and coverage stages

**Attributes**:
- `WorkflowName` (string): GitHub Actions workflow name (e.g., `.NET CI`)
- `Trigger` (enum): `Push`, `PullRequest`, `Manual`
- `Stages` (List<Stage>): Sequential stages (Build → Test → Coverage → Publish)
- `ArtifactName` (string): Published artifact name (e.g., `coverage-report`)
- `Runner` (string): GitHub Actions runner (e.g., `ubuntu-latest`)

**Stages**:
1. **Build**: `dotnet restore` → `dotnet build --no-restore`
2. **Test**: `dotnet test --no-build --collect:"XPlat Code Coverage"`
3. **Coverage Enforcement**: `reportgenerator --failonminimumcoverage:90`
4. **Artifact Publish**: Upload HTML reports

**State Transitions**:
- Each stage MUST pass before next stage runs
- If any stage fails, pipeline terminates immediately (no retries)

**Timeout**: 10 minutes (NFR-002: target <5 minutes)

**Examples**:
```yaml
name: .NET CI
on: [push, pull_request]
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - checkout
      - setup-dotnet
      - restore
      - build
      - test
      - coverage-check
      - publish-artifact
```

---

## Relationships

```
RuleTestSuite --1:N--> TestResult
  (One test suite contains many test executions)

TestCoverageReport --1:N--> FileCoverageReport
  (One coverage report aggregates many file reports)

IntegrationTestScenario --1:N--> TestResult
  (One scenario produces many test results)

CIPipeline --1:1--> TestCoverageReport
  (One CI run produces one coverage report)
```

---

## No Persistent Storage

**Important**: None of these entities are persisted to a database. They exist as:
- **Test execution**: In-memory xUnit test results
- **Coverage files**: Temporary XML files in `TestResults/` directory (deleted after CI run)
- **CI artifacts**: HTML reports stored by GitHub Actions (90-day retention)

---

## Alignment with Success Criteria

| Success Criteria | Data Model Support |
|------------------|-------------------|
| SC-001: 100% rules have tests | `RuleTestSuite` validates test file existence |
| SC-002: ≥90% coverage | `TestCoverageReport.LineCoveragePercent ≥ 90` |
| SC-003: <5s local tests | `TestResult.Duration` aggregated |
| SC-004: <5min CI feedback | `CIPipeline.Stages` total duration |
| SC-005: No false positives | `TestCoverageReport` validation rules |
| SC-006: Clear reports | `FileCoverageReport.UncoveredLineNumbers` |
| SC-007: 100% commits validated | `CIPipeline.Trigger` on all branches |
| SC-008: Single command local coverage | Command: `dotnet test --collect:"XPlat Code Coverage"` |
